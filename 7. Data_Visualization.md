# Data Analysis through Visualization

In this section, we will perform the following steps of the End-to-End ELT Pipeline.

**Step 7: Analysis**

- **Tool:** streamlit
- **Action:** With the data now clean and in a star schema, BI tools can connect directly to the production schema in the data warehouse to create dashboards and reports for advanced analytics.
- **Output:** Dashboard or reports can be created through data visualization to gain insights into the data.

## 1. Data Visualization Tool

There are several choices of tool with pros and cons, streamlit is chosen due to it's advanced visualization where it excels at story telling.

Below is a list of potential candidates and their key features:

#### Free / Open Source Options for BigQuery

a.	Looker Studio (Data Studio)
	•	100% free.
	•	Natively connects to BigQuery.
	•	Drag-and-drop dashboards, filters, KPIs.
	•	Downsides: performance issues on very large queries, fewer advanced charts.

b.	Metabase (open source)
	•	Free to self-host (Docker/JAR).
	•	Native BigQuery driver.
	•	Simple question/answer style queries → dashboards.
	•	Great for a small team, super easy setup.

c.	Apache Superset (open source)
	•	Free, enterprise-grade BI.
	•	BigQuery connector available.
	•	Strong dashboards, advanced charting, permissions.
	•	Heavier setup (needs Docker/K8s, some devops).
d.	Google Sheets + Connected Sheets
	•	Also free.
	•	Can query BigQuery directly, visualize with Sheets charts/pivots.
	•	Good for analysts who live in spreadsheets.

e. Streamlit
	•	It’s not a BI tool, it’s a Python framework for quickly building interactive web apps.
	•	100% free, open source.
	•	You can query BigQuery with the Python client (google-cloud-bigquery) and visualize using Plotly, Altair, or Matplotlib.
	•	Full flexibility: custom KPIs, charts, even ML integrations.
	•	Deploy to Streamlit Community Cloud (free for small apps) or your own infra.
	•	Requires Python skills.
	•	You’ll be responsible for writing queries, caching, and layouts.
	•	Not as “plug and play” as Looker Studio/Tableau.

## 2. Visualization Features

i. BigQuery Integration
	•	Connected to BigQuery m2_prod dataset.
	•	Supports service account JSON authentication via environment variable (GOOGLE_APPLICATION_CREDENTIALS).
	•	Optionally works with gcloud OAuth credentials for local dev.

ii. Data Extraction & Transformation
	•	Pulls data from fact_order_items and all dimension tables (dim_customers, dim_sellers, dim_products, dim_dates, dim_payments, dim_geolocation).
	•	Handles missing or optional data using LEFT JOIN and COALESCE.
	•	Cleans and casts timestamp columns for consistent date/time handling.

iii. Filters & Parameters
	•	Sidebar filters:
	•	Order date range
	•	Customer state
	•	Payment type
	•	Route map controls:
	•	Max number of orders to plot
	•	Sampling method: First N or Random
	•	Refresh routes dynamically

iv. KPIs
	•	Total Orders (order_id count)
	•	Total Revenue (price sum)
	•	Average Review Score

v. Charts
	•	Revenue by Review Score (histogram)
	•	Delivery Time Distribution (histogram)
	•	Top-N Product Categories by revenue (bar chart, dynamically configurable)

vi. Geospatial Features
	•	Customer & Seller Geolocation Map (scatter_mapbox)
	•	Delivery Routes Map:
	•	Plots lines from seller → customer
	•	Distance calculated using Haversine formula
	•	Color gradient reflects distance traveled
	•	Caching of route calculations for performance (@st.cache_data)

vii. Seed & Reference Table Integration
	•	Product category translation (product_category_name_translation.csv) used to convert Portuguese categories → English.
	•	Loaded via dbt seed, referenced in dim_products.

viii. Incremental & Efficient Data Loading
	•	Queries are cached (@st.cache_data) to reduce repeated BigQuery queries.
	•	Fact table supports incremental loading (via dbt) for daily/weekly updates.

ix. Data Download
	•	Download filtered dataset as CSV directly from Streamlit.
	•	Handles all applied filters.

x. dbt Integration Features
	•	Full dbt star schema: staging, dimensions, incremental fact table.
	•	Tested for:
	•	Primary key uniqueness and not null
	•	Relationships / foreign keys between fact → dimension tables
	•	dbt ensures data quality and lineage.

xi. Performance & UX Enhancements
	•	Handles large datasets efficiently using:
	•	Incremental fact table processing
	•	Map sampling for routes
	•	Cached BigQuery results
	•	Dynamic sidebar for interactive filtering
	•	Fully responsive layout using st.columns and plotly.express charts

## 3. Tool Setup

Create conda environment with python version 3.9 to 3.13. In this case 'elt'

Activate the conda env:
```
conda activate elt
```
Install streamlit:
```
pip install streamlit
```
Test that the installation worked by launching the Streamlit Hello example app:
```
streamlit hello
```
Before running the app, set the env variables to store your connection details:
```
nano ~/.zshrc 
```
```
--> Updates the GCP credential path

export GOOGLE_APPLICATION_CREDENTIALS="<path to secret key>>"

export PROJECT_ID="<GCP Project ID>"

```
Develop your app and save as olist_report.py, run your streamlit app:
```
streamlit run olist_report.py
```

### 4. Data Visualization Reports:

Each report is presented as a selectable from side bar with filters such as "Year" and "States" included to further slice the data:

- [1_Sales_&_Revenue.py](./streamlit/pages/1_Sales_&_Revenue.py)
- [2_Customer_Insights.py](./streamlit/pages/2_Customer_Insights.py)
- [3_Product_Performance.py](./streamlit/pages/3_Product_Performance.py)
- [4_Order_Fulfillment.py](./streamlit/pages/4_Order_Fulfillment.py)
- [5_Geospatial.py](./streamlit/pages/5_Geospatial.py)
- [6_Seller_Performance.py](./streamlit/pages/6_Seller_Performance.py)
- [7_Product_Analytics.py](./streamlit/pages/7_Product_Analytics.py)
- [8_Customer_Analytics.py](./streamlit/pages/8_Customer_Analytics.py)

### 5. Data Visualization in Action:

After succussful deployment, here are snapshot views of the dashboard:

![streamlit dash](./assets/1_Sales_1.png)
![streamlit dash](./assets/1_Sales_2.png)
![streamlit dash](./assets/2_Consumer_1.png)
![streamlit dash](./assets/2_Consumer_2.png)
![streamlit dash](./assets/3_Product_1.png)
![streamlit dash](./assets/3_Product_2.png)
![streamlit dash](./assets/4_Order_1.png)
![streamlit dash](./assets/4_Order_2.png)
![streamlit dash](./assets/4_Order_3.png)
![streamlit dash](./assets/5_Geo_1.png)
![streamlit dash](./assets/5_Geo_2.png)
![streamlit dash](./assets/5_Geo_3.png)
![streamlit dash](./assets/5_Geo_4.png)
![streamlit dash](./assets/6_Seller_1.png)
![streamlit dash](./assets/6_Seller_2.png)
![streamlit dash](./assets/6_Seller_3.png)
![streamlit dash](./assets/7_Product_Analytics_1.png)
![streamlit dash](./assets/7_Product_Analytics_2.png)
![streamlit dash](./assets/8_Customer_Analytics_1.png)
![streamlit dash](./assets/8_Customer_Analytics_2.png)

## Next Phase:

Additional views can be built to gain more in-depth insights, below are proposed for next phase:

### Additional Views and Insights

#### a. Sales & Revenue Insights

Monthly/Quarterly Revenue Trend
Visualize revenue over time to spot seasonality, growth trends, or dips.
Implementation: Group orders by month/quarter and sum revenue, then line/bar chart.

Average Order Value (AOV)
Revenue divided by number of orders over a period to measure spending per order.
Implementation: total_revenue / total_orders.

Customer Lifetime Value (CLV)
Estimate how much revenue a customer generates over their lifetime.
Implementation: Aggregate revenue per customer, maybe cohort analysis.

Revenue by Channel / Payment Type
Compare revenue generated from different payment methods or sales channels.

#### b. Customer Insights

Customer Segmentation
Group customers by location, spending behavior, or order frequency.
Implementation: Use RFM (Recency, Frequency, Monetary) analysis.

Repeat Purchase Rate
Percentage of customers who made more than one purchase.

New vs Returning Customers Over Time
Show how many new customers vs returning customers are ordering per period.

#### c. Product Performance

Product Category Sales Trends
Show how different categories perform over time.

Top Products by Units Sold
Complement top revenue products with volume sold.

Product Return Rate
If you have returns data, calculate return rates by product or category.

#### d. Order Fulfillment & Delivery

Average Delivery Time Trend
Show how delivery time improves or worsens over time.

Delivery Time by Seller or Region
Identify sellers or locations with slower/faster delivery.

Late Delivery Rate
Percentage of orders delivered past expected date.

#### e. Geospatial Analytics

Sales Heatmap by State or City
Map showing revenue density geographically.

Seller vs Customer Distance Distribution
Visualize average delivery distances, identify remote areas.

Delivery Route Optimization Suggestions
Using clustering or routing algorithms to suggest efficiency improvements.

#### f. Operational KPIs

Payment Failure Rate
Show how often payment attempts fail by payment type.

Order Cancellation Rate
Percentage of orders canceled after placement.

Inventory Alerts
Highlight products low in stock (if inventory data available).

#### g. User Experience & Feedback

Review Score Distribution Over Time
Track customer satisfaction trends.

Sentiment Analysis on Reviews
If you have textual reviews, analyze positive/negative sentiment.

#### h. Advanced Analytics

Churn Prediction
Identify customers at risk of not returning.

Cross-sell & Upsell Opportunities
Analyze frequently bought together products.

Forecasting
Predict future sales or demand by product or region.

#### Bonus: Interactive Features

Dynamic Drilldowns
Click on a product/category or region to drill deeper.

Custom Date Range & Comparison
Compare KPIs between two selected periods.

Alerts & Notifications
Show warnings if KPIs fall below targets.
